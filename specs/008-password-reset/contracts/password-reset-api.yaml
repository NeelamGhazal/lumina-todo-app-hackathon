openapi: 3.0.3
info:
  title: Password Reset API
  description: API endpoints for forgot password and password reset functionality
  version: 1.0.0

servers:
  - url: http://localhost:8000
    description: Development server

paths:
  /auth/forgot-password:
    post:
      summary: Request password reset
      description: |
        Initiates password reset flow by sending an email with reset link.
        Returns same response regardless of email existence (prevents enumeration).
        Rate limited to 3 requests per email per hour.
      operationId: forgotPassword
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
            example:
              email: "user@example.com"
      responses:
        '200':
          description: Request processed (same response for existing/non-existing emails)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForgotPasswordResponse'
              example:
                message: "If an account exists with this email, you will receive a reset link shortly"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "RATE_LIMIT_EXCEEDED"
                message: "Too many reset requests. Please try again later."
        '422':
          description: Validation error (invalid email format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /auth/verify-reset-token/{token}:
    get:
      summary: Verify reset token validity
      description: |
        Checks if a password reset token is valid and not expired.
        Used by frontend to validate token before showing reset form.
      operationId: verifyResetToken
      tags:
        - Authentication
      parameters:
        - name: token
          in: path
          required: true
          description: Password reset token from email link
          schema:
            type: string
            example: "abc123xyz789..."
      responses:
        '200':
          description: Token verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyTokenResponse'
              examples:
                valid:
                  summary: Valid token
                  value:
                    valid: true
                    email: "user@example.com"
                invalid:
                  summary: Invalid token
                  value:
                    valid: false
                    email: null
                    error: "Invalid reset link"
                expired:
                  summary: Expired token
                  value:
                    valid: false
                    email: null
                    error: "This reset link has expired"

  /auth/reset-password:
    post:
      summary: Reset password with token
      description: |
        Sets a new password using a valid reset token.
        Token is invalidated after successful password change.
      operationId: resetPassword
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
            example:
              token: "abc123xyz789..."
              password: "NewPassword123"
              password_confirm: "NewPassword123"
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResetPasswordResponse'
              example:
                success: true
                message: "Password has been reset successfully"
        '400':
          description: Invalid request (token invalid, expired, or passwords don't match)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_token:
                  summary: Invalid token
                  value:
                    error: "INVALID_TOKEN"
                    message: "Invalid reset link. Please request a new one."
                expired_token:
                  summary: Expired token
                  value:
                    error: "TOKEN_EXPIRED"
                    message: "This reset link has expired. Please request a new one."
                already_used:
                  summary: Token already used
                  value:
                    error: "TOKEN_USED"
                    message: "This reset link has already been used."
                password_mismatch:
                  summary: Passwords don't match
                  value:
                    error: "PASSWORD_MISMATCH"
                    message: "Passwords do not match"
        '422':
          description: Password validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PasswordValidationErrorResponse'
              example:
                error: "INVALID_PASSWORD"
                message: "Password does not meet requirements"
                details:
                  - "Password must be at least 8 characters"
                  - "Password must contain at least 1 uppercase letter"

components:
  schemas:
    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email address of the account to reset

    ForgotPasswordResponse:
      type: object
      properties:
        message:
          type: string
          description: Generic success message (same for all cases)

    VerifyTokenResponse:
      type: object
      properties:
        valid:
          type: boolean
          description: Whether the token is valid
        email:
          type: string
          nullable: true
          description: User's email if token is valid
        error:
          type: string
          nullable: true
          description: Error message if token is invalid

    ResetPasswordRequest:
      type: object
      required:
        - token
        - password
        - password_confirm
      properties:
        token:
          type: string
          description: Reset token from email link
        password:
          type: string
          minLength: 8
          description: New password (8+ chars, 1 uppercase, 1 number)
        password_confirm:
          type: string
          description: Password confirmation (must match password)

    ResetPasswordResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message

    PasswordValidationErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: string
          description: List of password validation errors

    ValidationErrorResponse:
      type: object
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  type: string
              msg:
                type: string
              type:
                type: string
